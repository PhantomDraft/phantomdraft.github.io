{{ define "main" }}
<section class="castration fl p_relative modules">

    {{ if .IsHome }}
        <!-- Здесь блок оформления шапки, если требуется -->
        <div class="castration cover p_relative atcCentral">
            <!-- Любой контент обложки -->
        </div>
    {{ end }}

    <ul id="content">
        {{/* Условие: если главная и первая страница пагинации */}}
        {{ if and .IsHome (eq .Paginator.PageNumber 1) }}

            {{/*
               1) Собираем список всех страниц (RegularPages),
                  которые не скрыты (hideFromCenter != true),
                  и которые уже отсортированы Hugo по дате (убывание).
                  Используем .ByDate.Reverse, чтобы не было ошибки сортировки.
            */}}
            {{ $allPages := where .Site.RegularPages.ByDate.Reverse ".Params.hideFromCenter" "!=" true }}

            {{/*
               2) Берём 3 последних из раздела "articles" (т. е. первые 3 в уже обратном списке).
            */}}
            {{ $forcedArticles := first 3 (where $allPages "Section" "articles") }}

            {{/*
               3) Берём 3 последних из раздела "library".
            */}}
            {{ $forcedLibrary := first 3 (where $allPages "Section" "library") }}

            {{/*
               4) Собираем Permalink (или RelPermalink) всех выбранных,
                  чтобы потом исключить их из общего списка.
            */}}
            {{ $forcedIDs := slice }}
            {{ range $forcedArticles }}
                {{ $forcedIDs = $forcedIDs | append .RelPermalink }}
            {{ end }}
            {{ range $forcedLibrary }}
                {{ $forcedIDs = $forcedIDs | append .RelPermalink }}
            {{ end }}

            {{/*
               5) Формируем список остальных, исключая принудительно выбранные.
            */}}
            {{ $others := slice }}
            {{ range $allPages }}
                {{ if not (in $forcedIDs .RelPermalink) }}
                    {{ $others = $others | append . }}
                {{ end }}
            {{ end }}

            {{/*
               6) Итоговый массив: [3 articles, 3 library, все остальные].
            */}}
            {{ $combined := append (append $forcedArticles $forcedLibrary) $others }}

            {{/* Для удобства: ссылки (RelPermalink) из библиотечных постов */}}
            {{ $forcedLibraryLinks := slice }}
            {{ range $forcedLibrary }}
                {{ $forcedLibraryLinks = $forcedLibraryLinks | append .RelPermalink }}
            {{ end }}

            {{/*
               7) Пагинация по собранному списку. Количество на странице
                  указывается в .Site.Params.page.maxHomePostCount или paginate
                  (зависит от вашей конфигурации).
            */}}
            {{ $paginator := .Paginate $combined .Site.Params.page.maxHomePostCount }}

            {{/* 8) Выводим материалы с нужной обёрткой */}}
            {{ range $paginator.Pages }}
                {{ if and (eq .Section "library") (in $forcedLibraryLinks .RelPermalink) }}
                    <div class="library-wrapper">
                        {{ partial "widgets/post-card.html" . }}
                    </div>
                {{ else }}
                    {{ partial "widgets/post-card.html" . }}
                {{ end }}
            {{ end }}

        {{ else }}
            {{/*
               Для остальных страниц главной (2-я, 3-я...) —
               обычная пагинация по датам убывания.
            */}}
            {{ $filteredPages := where .Site.RegularPages.ByDate.Reverse ".Params.hideFromCenter" "!=" true }}
            {{ $paginator := .Paginate $filteredPages .Site.Params.page.maxHomePostCount }}
            {{ range $paginator.Pages }}
                {{ partial "widgets/post-card.html" . }}
            {{ end }}
        {{ end }}
    </ul>

    {{ partial "widgets/aside.html" . }}

</section>
{{ end }}
