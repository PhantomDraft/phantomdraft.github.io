{{ define "main" }}
<section class="castration fl p_relative modules">

    {{ if .IsHome }}
        <!-- Шапка / Обложка -->
        <div class="castration cover p_relative atcCentral" 
             style="background-image: linear-gradient(black, black), url(/img/cover/default.webp); 
                    background-blend-mode: saturation; background-position-y: 30% !important;">
            <div class="fl p_relative">
                <a title="Instagram" rel="nofollow" href="https://www.instagram.com/horrorprom" target="_blank">
                    <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
                <a title="YouTube" rel="nofollow" href="https://www.youtube.com/@spirits-show" target="_blank">
                    <i class="fa fa-youtube-play" aria-hidden="true"></i>
                </a>
            </div>
            <div class="fr p_relative">
                <a title="Discord" rel="nofollow" href="https://discord.com/users/morguenal" target="_blank">
                    <i class="fa fa-gamepad" aria-hidden="true"></i>
                </a>
            </div>
            <div class="t_center castration base_width p_relative">
                <p>{{ i18n "soc_block_title" }}</p>
                <p>{{ i18n "soc_block_desc" | safeHTML }}</p>
            </div>
        </div>
    {{ end }}

    <ul id="content">

        {{/* Проверяем: главная страница + первая пагинация? */}}
        {{ if and .IsHome (eq .Paginator.PageNumber 1) }}

            {{/* 1) Собираем все страницы, которые НЕ hideFromCenter */}}
            {{ $allPages := where .Site.RegularPages ".Params.hideFromCenter" "!=" true }}

            {{/* 2) Сортируем по Lastmod (убывание). 
                   Если выдаёт ошибку — замените на: 
                   $sortedAll := .Site.RegularPages.ByLastmod.Reverse | where ".Params.hideFromCenter" "!=" true 
            */}}
            {{ $sortedAll := sort $allPages "Lastmod" "desc" }}

            {{--
               3) Из $sortedAll берём 3 последних "articles", 
                  потом 3 "library", не допуская дублей.
            --}}
            {{ $forcedArticles := slice }}
            {{ $forcedLibrary := slice }}

            {{/* сначала 3 articles (если меньше 3, берётся сколько есть) */}}
            {{ $tmpArticles := first 3 (where $sortedAll "Section" "articles") }}
            {{ $forcedArticles = $forcedArticles | append $tmpArticles }}

            {{/*
                потом 3 library, но исключая из library те, что уже попали в articles 
                (чтобы не было дублирования одного и того же поста).
            */}}
            {{ $tmpLibrary := slice }}
            {{ range (where $sortedAll "Section" "library") }}
                {{ if not (in (slice) $forcedArticles .) }}
                    {{ $tmpLibrary = $tmpLibrary | append . }}
                {{ end }}
            {{ end }}
            {{ $forcedLibrary = first 3 $tmpLibrary }}

            {{/*
               4) Собираем их .RelPermalink, чтобы исключить из общего массива
            */}}
            {{ $forcedIDs := slice }}
            {{ range $forcedArticles }}
                {{ $forcedIDs = $forcedIDs | append .RelPermalink }}
            {{ end }}
            {{ range $forcedLibrary }}
                {{ $forcedIDs = $forcedIDs | append .RelPermalink }}
            {{ end }}

            {{/*
               5) Удаляем принудительные из $sortedAll => $remaining
            */}}
            {{ $remaining := slice }}
            {{ range $sortedAll }}
                {{ if not (in $forcedIDs .RelPermalink) }}
                    {{ $remaining = $remaining | append . }}
                {{ end }}
            {{ end }}

            {{/*
               6) Подсчитываем, сколько ещё нужно «добрать» в первую страницу 
                  (чтобы итогом было .Site.Params.page.maxHomePostCount).
                  Если forcedArticles + forcedLibrary уже = 6, 
                  то "добрать" = 3. Если где-то меньше (нет 3 статей), будет побольше.
            */}}
            {{ $need := sub .Site.Params.page.maxHomePostCount (add (len $forcedArticles) (len $forcedLibrary)) }}
            {{ if lt $need 0 }} 
                {{/* Если получилось отрицательное => уже набрали больше, чем нужно. Обрубим */}}
                {{ $need = 0 }}
            {{ end }}

            {{/*
               7) first $need из $remaining => это 0..3 дополнительных постов,
                  чтобы в сумме на первой странице оказалось ровно 9 (или paginate).
            */}}
            {{ $additional := first $need $remaining }}

            {{/*
               8) Убираем эти добавленные из $remaining, чтобы не дублировались.
            */}}
            {{ $addedIDs := slice }}
            {{ range $additional }}
                {{ $addedIDs = $addedIDs | append .RelPermalink }}
            {{ end }}
            {{ $remaining2 := slice }}
            {{ range $remaining }}
                {{ if not (in $addedIDs .RelPermalink) }}
                    {{ $remaining2 = $remaining2 | append . }}
                {{ end }}
            {{ end }}

            {{/*
               9) Собираем финальный массив:
                  [принудительные статьи + библиотека + добор], 
                  а затем всё остальное.
            */}}
            {{ $frontBlock := append (append $forcedArticles $forcedLibrary) $additional }}
            {{ $final := append $frontBlock $remaining2 }}

            {{/*
               10) Пагинация по $final.
               На первой странице выведется именно $frontBlock (то есть 9 шт. максимум).
               На второй и далее — пойдёт $remaining2, в том же порядке убывания Lastmod.
            */}}
            {{ $paginator := .Paginate $final .Site.Params.page.maxHomePostCount }}

            {{/*
               Обёртка для библиотечных записей:
               соберём permalinks "library", если хотим особый <div> обёртки
            */}}
            {{ $libraryIDs := slice }}
            {{ range $forcedLibrary }}
                {{ $libraryIDs = $libraryIDs | append .RelPermalink }}
            {{ end }}

            <!-- Выводим посты на текущей (первой) странице -->
            {{ range $paginator.Pages }}
                {{ if and (eq .Section "library") (in $libraryIDs .RelPermalink) }}
                    <div class="library-wrapper">
                        {{ partial "widgets/post-card.html" . }}
                    </div>
                {{ else }}
                    {{ partial "widgets/post-card.html" . }}
                {{ end }}
            {{ end }}

            <!-- Пагинация (можно подключить ваш advanced partial) -->
            <ul class="t_center not_twitch">
                {{ if $paginator.HasPrev }}
                <li class="page-numbers">
                    <a href="{{ $paginator.Prev.URL }}" class="page-numbers prev">
                        {{ i18n "pagination_previous" }}
                    </a>
                </li>
                {{ end }}
                {{ range $paginator.Pagers }}
                <li class="page-numbers">
                    {{ if eq .PageNumber $paginator.PageNumber }}
                        <span class="page-numbers active">{{ .PageNumber }}</span>
                    {{ else }}
                        <a href="{{ .URL }}" class="page-numbers">{{ .PageNumber }}</a>
                    {{ end }}
                </li>
                {{ end }}
                {{ if $paginator.HasNext }}
                <li class="page-numbers">
                    <a href="{{ $paginator.Next.URL }}" class="page-numbers next">
                        {{ i18n "pagination_next" }}
                    </a>
                </li>
                {{ end }}
            </ul>

        {{ else }}

            <!-- Не первая страница: обычная логика -->
            {{ $filtered := where .Site.RegularPages ".Params.hideFromCenter" "!=" true }}
            {{ $sorted := sort $filtered "Lastmod" "desc" }}
            {{ $paginator := .Paginate $sorted .Site.Params.page.maxHomePostCount }}

            {{ range $paginator.Pages }}
                {{ partial "widgets/post-card.html" . }}
            {{ end }}

            <ul class="t_center not_twitch">
                {{ if $paginator.HasPrev }}
                <li class="page-numbers">
                    <a href="{{ $paginator.Prev.URL }}" class="page-numbers prev">
                        {{ i18n "pagination_previous" }}
                    </a>
                </li>
                {{ end }}
                {{ range $paginator.Pagers }}
                <li class="page-numbers">
                    {{ if eq .PageNumber $paginator.PageNumber }}
                        <span class="page-numbers active">{{ .PageNumber }}</span>
                    {{ else }}
                        <a href="{{ .URL }}" class="page-numbers">{{ .PageNumber }}</a>
                    {{ end }}
                </li>
                {{ end }}
                {{ if $paginator.HasNext }}
                <li class="page-numbers">
                    <a href="{{ $paginator.Next.URL }}" class="page-numbers next">
                        {{ i18n "pagination_next" }}
                    </a>
                </li>
                {{ end }}
            </ul>
        {{ end }}
    </ul>

    {{ partial "widgets/aside.html" . }}
</section>
{{ end }}
