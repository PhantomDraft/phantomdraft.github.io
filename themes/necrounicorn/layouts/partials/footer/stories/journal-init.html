<script>
    jQuery('#fb5').data('config', {
        "page_width":"550",
        "page_height":"715",
        "email_form":"office@somedomain.com",
        "zoom_double_click":"1",
        "zoom_step":"0.06",
        "double_click_enabled":"true",
        "tooltip_visible":"true",
        "toolbar_visible":"true",
        "gotopage_width":"30",
        "deeplinking_enabled":"true",
        "rtl":"false",
        'full_area':'true',
        'lazy_loading_thumbs':'false',
        'lazy_loading_pages':'false'
    });

$(function () {
    // Функция для получения последней страницы
    function getLastPageNumber() {
        let lastPage = 0;
        $('.turn-page-wrapper').each(function () {
            const page = parseInt($(this).attr('page'), 10);
            if (page > lastPage) {
                lastPage = page;
            }
        });
        return lastPage;
    }

    // Проверяем, виден ли элемент
    function isElementVisible($element) {
        return $element.css('display') !== 'none' && $element.is(':visible');
    }

    // Функция для активации подсказок на текущих видимых страницах
    function activateHintsForPages(pages) {
        introJs().removeHints(); // Удаляем все подсказки

        pages.forEach(function (page) {
            const $pageWrapper = $(`.turn-page-wrapper[page="${page}"]`);
            if (isElementVisible($pageWrapper)) {
                const $currentHints = $pageWrapper.find('[data-hint]');
                $currentHints.each(function () {
                    const element = $(this).get(0);
                    introJs().addHints([{
                        element: element,
                        hint: $(this).attr('data-hint'),
                        position: $(this).attr('data-hintposition') || 'bottom-middle',
                    }]);
                });
            }
        });

        introJs().refresh(); // Обновляем подсказки
    }

    // Функция для анимации изображений
    function animateImages(page1, page2) {
        const $images = $(`.turn-page-wrapper[page="${page1}"]:visible, .turn-page-wrapper[page="${page2}"]:visible`).find('.fb5-cont-page-book img');
        if ($images.length === 0) {
            console.warn("Изображения не найдены для страниц:", page1, page2);
            return;
        }
        $images.each(function (index, img) {
            $(img).css({
                'opacity': 0, // Начальная прозрачность
                'transition': 'opacity 1s ease-in', // Плавное изменение прозрачности
                'transition-delay': (index * 0.5) + 's' // Задержка для каждого изображения
            });
            setTimeout(function () {
                $(img).css('opacity', 1); // Делаем изображение видимым
            }, index * 500);
        });
    }

    // Обработчик адреса
    function handleAddressChange(address) {
        let pages = [];

        if (address === "book5/page1") {
            // Первая страница
            pages.push("1");
        } else if (address === "book5/end") {
            // Последняя страница
            const lastPage = getLastPageNumber();
            pages.push(String(lastPage));
        } else {
            // Диапазоны страниц, например, "page2-page3"
            const pageMatch = address.match(/page(\d+)-page(\d+)/);
            if (pageMatch) {
                const page1 = pageMatch[1];
                const page2 = pageMatch[2];
                pages.push(page1, page2);
                // Запускаем анимацию изображений для текущих страниц
                animateImages(page1, page2);
            }
        }

        if (pages.length > 0) {
            console.log("Активируем подсказки для страниц:", pages);
            activateHintsForPages(pages);
        } else {
            console.warn("Не удалось извлечь страницы из адреса:", address);
        }
    }

    // Слушатель изменений якоря
    $(window).on("hashchange", function () {
        const currentAddress = window.location.hash.slice(1); // Убираем #
        console.log("Изменение адреса:", currentAddress);
        handleAddressChange(currentAddress);
    });

    // Инициализация при загрузке страницы
    const initialAddress = window.location.hash.slice(1);
    console.log("Инициализация адреса:", initialAddress);
    handleAddressChange(initialAddress);
});

</script>