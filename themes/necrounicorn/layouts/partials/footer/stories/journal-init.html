<script>
    jQuery('#fb5').data('config', {
        "page_width":"550",
        "page_height":"715",
        "email_form":"office@somedomain.com",
        "zoom_double_click":"1",
        "zoom_step":"0.06",
        "double_click_enabled":"true",
        "tooltip_visible":"true",
        "toolbar_visible":"true",
        "gotopage_width":"30",
        "deeplinking_enabled":"true",
        "rtl":"false",
        'full_area':'true',
        'lazy_loading_thumbs':'false',
        'lazy_loading_pages':'false'
    });

$(function () {
    // Функция для проверки видимости страницы
    function isPageVisible($page) {
        return $page.css('display') !== 'none' && $page.is(':visible');
    }

    // Обновление активных страниц
    function updateActivePages() {
        $('.turn-page-wrapper').each(function () {
            const $page = $(this);
            $page.removeClass('active'); // Удаляем класс перед проверкой

            if (isPageVisible($page)) {
                $page.addClass('active'); // Добавляем класс только видимым страницам
            }
        });
    }

    // Функция для получения активных страниц
    function getActivePages() {
        const activePages = [];
        $('.turn-page-wrapper.active').each(function () {
            const page = $(this).attr('page');
            if (page) {
                activePages.push(page);
            }
        });
        return activePages;
    }

    // Функция для подсказок
    function activateHints() {
        introJs().removeHints(); // Удаляем старые подсказки

        const activePages = getActivePages();
        console.log("Активные страницы:", activePages);

        activePages.forEach(function (page) {
            const $pageWrapper = $(`.turn-page-wrapper[page="${page}"]`);
            const $currentHints = $pageWrapper.find('[data-hint]');
            $currentHints.each(function () {
                const element = $(this).get(0);
                introJs().addHints([{
                    element: element,
                    hint: $(this).attr('data-hint'),
                    position: $(this).attr('data-hintposition') || 'bottom-middle',
                }]);
            });
        });

        introJs().refresh();
    }

    // Функция для анимации изображений
    function animateImages() {
        const activePages = getActivePages();

        activePages.forEach(function (page) {
            const $images = $(`.turn-page-wrapper[page="${page}"]`).find('.fb5-cont-page-book img');
            $images.each(function (index, img) {
                $(img).css({
                    'opacity': 0,
                    'transition': 'opacity 1s ease-in',
                    'transition-delay': `${index * 0.5}s`
                });
                setTimeout(function () {
                    $(img).css('opacity', 1);
                }, index * 500);
            });
        });
    }

    // Обработчик изменения страницы
    function handlePageChange() {
        updateActivePages(); // Сначала обновляем активные страницы
        const activePages = getActivePages();
        console.log("Текущие активные страницы:", activePages);

        if (activePages.length > 0) {
            animateImages(); // Анимация изображений
            activateHints(); // Подсказки для активных страниц
        } else {
            console.warn("Нет активных страниц для обработки.");
        }
    }

    // Слушатель изменений
    $(window).on("hashchange", function () {
        setTimeout(handlePageChange, 100); // Задержка для гарантии обновления DOM
    });

    // Инициализация
    setTimeout(handlePageChange, 100); // Задержка для начальной загрузки
});

</script>